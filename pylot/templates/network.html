
<!DOCTYPE html>
<html>
<head>
    <title>Network Topology - GrassMarlin Lite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin: 0 0 10px 0;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 4px;
            border-left: 4px solid #0074D9;
        }
        .stat-box strong {
            color: #0074D9;
        }
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        #cy {
            width: 100%;
            height: 600px;
            background-color: #fafafa;
        }
        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .btn {
            background-color: #0074D9;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0074D9;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="/" class="back-link">‚Üê Back to Upload</a>
    
    <div class="header">
        <h1>Network Topology Analysis</h1>
        <div class="stats">
            <div class="stat-box">
                <strong>{{ devices|length }}</strong> devices detected
            </div>
            <div class="stat-box">
                <strong>{{ connections|length }}</strong> connections found
            </div>
        </div>
    </div>

    <div class="container">
        <div id="cy"></div>
        <div class="controls">
            <button class="btn" onclick="resetLayout()">Reset Layout</button>
            <button class="btn" onclick="fitView()">Fit to View</button>
            <button class="btn" onclick="exportData()">Export Data</button>
        </div>
    </div>

    <script>
        let cy;
        
        fetch('/api/graph')
            .then(res => res.json())
            .then(data => {
                const nodes = {};
                const edges = [];

                data.forEach(conn => {
                    nodes[conn.data.source] = true;
                    nodes[conn.data.target] = true;
                    edges.push({ data: conn.data });
                });

                const elements = Object.keys(nodes).map(id => ({ 
                    data: { 
                        id,
                        label: id.length > 15 ? id.substring(0, 12) + '...' : id
                    } 
                })).concat(edges);

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { 
                            selector: 'node', 
                            style: { 
                                'label': 'data(label)', 
                                'background-color': '#0074D9',
                                'color': 'white',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'width': '120px',
                                'height': '60px',
                                'font-size': '10px',
                                'font-weight': 'bold',
                                'text-wrap': 'wrap',
                                'text-max-width': '100px'
                            } 
                        },
                        { 
                            selector: 'edge', 
                            style: { 
                                'label': 'data(label)', 
                                'line-color': '#666',
                                'target-arrow-shape': 'triangle',
                                'target-arrow-color': '#666',
                                'curve-style': 'bezier',
                                'font-size': '10px',
                                'text-rotation': 'autorotate'
                            } 
                        }
                    ],
                    layout: { 
                        name: 'cose',
                        animate: true,
                        animationDuration: 1000,
                        nodeDimensionsIncludeLabels: true,
                        nodeRepulsion: 8000,
                        idealEdgeLength: 200,
                        edgeElasticity: 100
                    }
                });
                
                // Add event listeners
                cy.on('mouseover', 'node', function(e) {
                    e.target.style('background-color', '#ff6b6b');
                    // Show tooltip with full IP
                    const node = e.target;
                    const ip = node.id();
                    if (ip.length > 15) {
                        node.style('label', ip);
                    }
                });
                
                cy.on('mouseout', 'node', function(e) {
                    e.target.style('background-color', '#0074D9');
                    // Restore original label
                    const node = e.target;
                    const ip = node.id();
                    if (ip.length > 15) {
                        node.style('label', ip.substring(0, 12) + '...');
                    }
                });
            })
            .catch(error => {
                console.error('Error loading graph data:', error);
                document.getElementById('cy').innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Error loading network data. Please try uploading a PCAP file first.</div>';
            });

        function resetLayout() {
            if (cy) {
                cy.layout({ name: 'cose' }).run();
            }
        }

        function fitView() {
            if (cy) {
                cy.fit();
            }
        }

        function exportData() {
            if (cy) {
                const data = {
                    nodes: cy.nodes().map(node => ({ id: node.id() })),
                    edges: cy.edges().map(edge => ({ 
                        source: edge.source().id(), 
                        target: edge.target().id(), 
                        label: edge.data('label') 
                    }))
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'network_topology.json';
                a.click();
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>
